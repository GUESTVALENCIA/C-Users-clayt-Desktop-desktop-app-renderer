<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: blob: https:; connect-src 'self' http://localhost:* https://* ws://localhost:*; frame-src 'self' https://*; child-src 'self' https://*;">
  <title>StudioLab - Multimodal Intelligence</title>
  
  <!-- Open Source Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
  
  <!-- StudioLab Styles -->
  <link rel="stylesheet" href="studiolab.css">
</head>
<body>
  <!-- ============================================
       TOP BAR
       ============================================ -->
  <header class="top-bar">
    <div class="top-bar-left">
      <div class="brand" onclick="toggleHistoryPanel()">
        <div class="brand-logo">S</div>
        <div class="brand-text">
          <span class="brand-name">StudioLab</span>
          <span class="brand-subtitle">Multimodal Intelligence</span>
        </div>
      </div>

      <nav class="menu-bar">
        <div class="menu-item">
          Archivo
          <div class="dropdown-menu">
            <div class="dropdown-item" onclick="newChat()">
              <span><span class="dropdown-item-icon">üìÑ</span>Nuevo Chat</span>
              <span class="dropdown-shortcut">Ctrl+N</span>
            </div>
            <div class="dropdown-item" onclick="openProject()">
              <span><span class="dropdown-item-icon">üìÇ</span>Abrir Proyecto</span>
              <span class="dropdown-shortcut">Ctrl+O</span>
            </div>
            <div class="dropdown-item" onclick="saveChat()">
              <span><span class="dropdown-item-icon">üíæ</span>Guardar Chat</span>
              <span class="dropdown-shortcut">Ctrl+S</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">üì§</span>Exportar</span>
              <span class="dropdown-shortcut">Ctrl+E</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">‚öôÔ∏è</span>Configuraci√≥n</span>
              <span class="dropdown-shortcut">Ctrl+,</span>
            </div>
          </div>
        </div>

        <div class="menu-item">
          Editar
          <div class="dropdown-menu">
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">‚Ü©Ô∏è</span>Deshacer</span>
              <span class="dropdown-shortcut">Ctrl+Z</span>
            </div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">‚Ü™Ô∏è</span>Rehacer</span>
              <span class="dropdown-shortcut">Ctrl+Y</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">üîç</span>Buscar</span>
              <span class="dropdown-shortcut">Ctrl+F</span>
            </div>
          </div>
        </div>

        <div class="menu-item">
          Ver
          <div class="dropdown-menu">
            <div class="dropdown-item" onclick="toggleHistoryPanel()">
              <span><span class="dropdown-item-icon">üìë</span>Panel de Chats</span>
              <span class="dropdown-shortcut">Ctrl+B</span>
            </div>
            <div class="dropdown-item" onclick="toggleCanvasPanel()">
              <span><span class="dropdown-item-icon">üé®</span>Panel Canvas</span>
              <span class="dropdown-shortcut">Ctrl+K</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item theme-submenu">
              <span><span class="dropdown-item-icon">üé®</span>Temas</span>
              <span>‚ñ∂</span>
              <div class="submenu">
                <div class="theme-option" data-theme="default" onclick="setTheme('default')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #00d4aa, #0d0d0d);"></span>
                  <span>Dark (Default)</span>
                </div>
                <div class="theme-option" data-theme="tokyo-night" onclick="setTheme('tokyo-night')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #7aa2f7, #1a1b26);"></span>
                  <span>Tokyo Night</span>
                </div>
                <div class="theme-option" data-theme="monokai" onclick="setTheme('monokai')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #a6e22e, #272822);"></span>
                  <span>Monokai</span>
                </div>
                <div class="theme-option" data-theme="synthwave" onclick="setTheme('synthwave')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #ff7edb, #262335);"></span>
                  <span>Synthwave 84</span>
                </div>
                <div class="theme-option" data-theme="solarized" onclick="setTheme('solarized')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #2aa198, #002b36);"></span>
                  <span>Solarized Dark</span>
                </div>
                <div class="theme-option" data-theme="red" onclick="setTheme('red')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #ff6b6b, #1a0a0a);"></span>
                  <span>Red</span>
                </div>
                <div class="theme-option" data-theme="kimbi" onclick="setTheme('kimbi')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #d19a66, #221a0f);"></span>
                  <span>Kimbi Dark</span>
                </div>
                <div class="theme-option" data-theme="ocean" onclick="setTheme('ocean')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #61afef, #0a1628);"></span>
                  <span>Ocean Blue</span>
                </div>
                <div class="theme-option" data-theme="purple" onclick="setTheme('purple')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #c792ea, #13091c);"></span>
                  <span>Purple Haze</span>
                </div>
                <div class="theme-option" data-theme="high-contrast" onclick="setTheme('high-contrast')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #00ff9f, #000000);"></span>
                  <span>High Contrast</span>
                </div>
                <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                  <span class="theme-color-preview" style="background: linear-gradient(135deg, #0066cc, #ffffff);"></span>
                  <span>Light</span>
                </div>
                <div class="dropdown-divider"></div>
                <div class="theme-option" onclick="customTheme()">
                  <span class="dropdown-item-icon">‚ûï</span>
                  <span>A√±adir tema personalizado...</span>
                </div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">üîç</span>Zoom In</span>
              <span class="dropdown-shortcut">Ctrl++</span>
            </div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">üîç</span>Zoom Out</span>
              <span class="dropdown-shortcut">Ctrl+-</span>
            </div>
          </div>
        </div>

        <div class="menu-item">
          Ejecutar
          <div class="dropdown-menu">
            <div class="dropdown-item" onclick="executeCode()">
              <span><span class="dropdown-item-icon">‚ñ∂Ô∏è</span>Ejecutar C√≥digo</span>
              <span class="dropdown-shortcut">F5</span>
            </div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">üêõ</span>Depurar</span>
              <span class="dropdown-shortcut">F9</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <span><span class="dropdown-item-icon">‚èπÔ∏è</span>Detener</span>
              <span class="dropdown-shortcut">Shift+F5</span>
            </div>
          </div>
        </div>

        <div class="menu-item" onclick="toggleTerminal()">
          Terminal
        </div>
      </nav>
    </div>

    <div class="top-bar-right">
      <div class="status-badge">
        <div class="status-dot"></div>
        <span>Conectado</span>
      </div>
    </div>
  </header>

  <!-- ============================================
       MAIN CONTAINER
       ============================================ -->
  <main class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button class="sidebar-btn qwen-btn" id="qwenBtn" title="Abrir QWEN Embebido" onclick="openQwenEmbedded()">
        <svg class="qwen-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="qwenGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.9" />
            </linearGradient>
          </defs>
          <circle cx="50" cy="45" r="28" fill="none" stroke="url(#qwenGrad)" stroke-width="3"/>
          <path d="M 70 60 L 85 85" stroke="url(#qwenGrad)" stroke-width="3" stroke-linecap="round"/>
          <rect x="40" y="35" width="20" height="20" fill="url(#qwenGrad)" opacity="0.6" rx="2"/>
        </svg>
      </button>

      <button class="sidebar-btn" id="historyBtn" onclick="toggleHistoryPanel()" title="Historial de Chats">üìë</button>
      <button class="sidebar-btn" onclick="newChat()" title="Nuevo Chat">‚ûï</button>
      <button class="sidebar-btn" id="searchBtn" onclick="toggleSearch()" title="Buscar Web">üîç</button>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-avatar" title="Perfil">C</div>
    </aside>

    <!-- History Panel -->
    <aside class="history-panel" id="historyPanel">
      <div class="panel-header">
        <span class="panel-title">üí¨ Historial</span>
        <button class="panel-close" onclick="toggleHistoryPanel()">√ó</button>
      </div>
      <div class="panel-search">
        <input type="text" class="search-input" placeholder="Buscar en chats...">
      </div>
      <div class="chat-list" id="chatList"></div>
    </aside>

    <!-- Chat Area -->
    <section class="chat-area">
      <!-- Model Selector -->
      <div class="model-selector-container">
        <div class="model-selector" id="modelSelector">
          <button class="model-trigger" id="modelTrigger" type="button">
            <span class="model-trigger-main">
              <span class="model-name" id="currentModelName">Cargando...</span>
              <span class="model-sub" id="currentModelSub">Detectando estado</span>
            </span>
            <span class="model-arrow">‚ñæ</span>
          </button>

          <div class="model-dropdown" id="modelDropdown">
            <div class="model-dropdown-header">
              <div class="model-dropdown-title">Modelos</div>
              <div class="model-auto" onclick="event.stopPropagation()">
                <span>Modo Auto</span>
                <button class="toggle" id="modelAutoToggle">
                  <span class="toggle-knob"></span>
                </button>
              </div>
            </div>
            <div class="model-list" id="modelListPrimary"></div>
            <button class="model-more" id="modelMoreBtn">
              <span>Desplegar m√°s modelos</span>
              <span>‚Ä∫</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Content Wrapper -->
      <div class="chat-content-wrapper">
        <div class="chat-messages" id="chatMessages">
          <div class="welcome-screen" id="welcomeScreen">
            <h1 class="welcome-greeting">Buenas tardes, <strong>Cley</strong></h1>
          </div>
          <div class="messages-container" id="messagesContainer"></div>
        </div>
      </div>

      <!-- Input Section -->
      <div class="input-section">
        <div class="composer" id="composer">
          <div class="input-container">
            <div class="input-main">
              <textarea
                class="input-textarea"
                id="messageInput"
                placeholder="¬øC√≥mo puedo ayudarte hoy?"
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this); updateSendButton()"
              ></textarea>
            </div>

            <div class="attachments-preview" id="attachmentsPreview" style="display: none;">
              <div class="attachments-container" id="attachmentsContainer"></div>
            </div>

            <div class="input-toolbar">
              <div class="toolbar-left">
                <div class="toolbar-btn attach-btn" id="attachBtn" onclick="toggleAttachMenu(event)">
                  <span class="toolbar-btn-icon">‚ûï</span>
                  <div class="attach-dropdown">
                    <div class="attach-option" onclick="attachFile('imagen')">
                      <span>üñºÔ∏è</span> <span>Im√°genes</span>
                    </div>
                    <!-- ... other attach options ... -->
                  </div>
                </div>

                <button class="toolbar-btn thinking-btn-small" id="thinkingBtn" onclick="toggleThinking()" title="Pensamiento">
                  <span class="toolbar-btn-icon">üß†</span>
                </button>

                <div class="cursor-mode-selector" id="modeSelectorUI">
                  <button class="cursor-mode-btn" id="modeBtnMain" onclick="toggleModeMenu(event)">
                    <span class="cursor-mode-icon" id="modeIcon">‚àû</span>
                    <span id="currentModeName">Agente</span>
                    <span class="cursor-dropdown-arrow">‚Ä∫</span>
                  </button>
                  <div class="cursor-mode-dropdown" id="modeDropdown" style="display: none;">
                    <div class="cursor-mode-option" onclick="selectMode('agente', 'Agente', '‚àû')">
                      <span class="cursor-mode-check">‚úì</span>
                      <span class="cursor-mode-icon">‚àû</span>
                      <span>Agente</span>
                    </div>
                    <div class="cursor-mode-option" onclick="selectMode('plan', 'Plan', 'üìã')">
                      <span class="cursor-mode-check"></span>
                      <span class="cursor-mode-icon">üìã</span>
                      <span>Plan</span>
                    </div>
                  </div>
                </div>

                <div class="provider-selector" id="providerSelector">
                   <!-- Providers will be initialized via JS or simple buttons -->
                   <button class="provider-btn" onclick="toggleProviderDropdown('groq', event)" title="Groq models">‚ö°</button>
                   <div id="dropdown-groq" class="provider-dropdown" style="display: none;"></div>
                </div>

                <button class="toolbar-btn auto-btn" id="autoBtn" onclick="toggleAutoMenu(event)">
                  <span class="toolbar-btn-icon">‚ö°</span>
                  <span id="autoLabel">AUTO</span>
                </button>
                <div class="auto-dropdown" id="autoDropdown" style="display: none;">
                   <div class="auto-function-btn" onclick="executeAutoFunction('auto')">Auto</div>
                   <div class="auto-function-btn" onclick="executeAutoFunction('multiple')">M√∫ltiple</div>
                </div>
              </div>

              <div class="toolbar-right">
                <div class="voice-btn" id="voiceBtn" onclick="toggleVoiceMenu(event)">
                  <span>üéôÔ∏è</span>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                  <span>‚Üë</span>
                </button>
              </div>
            </div>
          </div>

          <div class="terminal-panel" id="terminalPanel">
            <div class="terminal-header">
              <span class="panel-title">Terminal</span>
              <button class="panel-close" onclick="toggleTerminal()">√ó</button>
            </div>
            <div class="terminal-content" id="terminalContent"></div>
            <div class="terminal-input-row">
              <span class="terminal-prompt">$</span>
              <input class="terminal-input-field" id="terminalInput" type="text" placeholder="Comando..." />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Canvas Panel -->
    <aside class="canvas-panel" id="canvasPanel">
      <div class="canvas-header">
        <div class="canvas-tabs">
          <button class="canvas-tab active" onclick="setCanvasTab('code')">C√≥digo</button>
          <button class="canvas-tab" onclick="setCanvasTab('preview')">Preview</button>
        </div>
        <button class="panel-close" onclick="toggleCanvasPanel()">√ó</button>
      </div>
      <div class="canvas-content">
        <div id="canvasPaneCode" class="canvas-pane">
          <textarea id="canvasCode" class="canvas-code"></textarea>
        </div>
        <div id="canvasPanePreview" class="canvas-pane hidden">
          <iframe id="canvasPreview" class="canvas-preview"></iframe>
        </div>
      </div>
    </aside>
  </main>

  <!-- StudioLab Scripts -->
  <script type="module" src="studiolab-main.js"></script>
</body>
</html>
